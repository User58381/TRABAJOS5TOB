<!doctype html>
<html lang="es" data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Aula Digital â€” Consulta para familias</title>
<style>
  :root{
    --bg:#f7f9ff; --card:#ffffff; --text:#0b1020; --muted:#526072; --accent:#2b6bff;
    --bd:#d9e3ff; --ok:#0ea371; --warn:#f0b429; --bad:#ef4444;
    --barbg: color-mix(in oklab, var(--card) 80%, transparent);
  }
  [data-theme="dark"]{
    --bg:#0c1220; --card:#101a34; --text:#eaf3ff; --muted:#93a6bc; --accent:#6aa9ff;
    --bd:#223056; --ok:#1ec48d; --warn:#ffce3a; --bad:#ff7a7a; --barbg:#0a1330;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;z-index:10;background:color-mix(in oklab, var(--card) 90%, transparent);
    backdrop-filter:blur(6px); border-bottom:1px solid var(--bd); padding:14px 16px; display:flex; gap:12px; align-items:center}
  header h1{font-size:18px;margin:0}
  header .right{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;touch-action:manipulation}
  .btn.primary{background:var(--accent);color:white}
  .btn.ghost{background:transparent;border:1px solid var(--bd);color:var(--text)}
  .btn.small{padding:8px 10px;border-radius:10px}
  main{max-width:960px;margin:auto;padding:18px}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:16px}
  .hero{display:grid;gap:12px}
  .input{display:grid;grid-template-columns:1fr auto auto;gap:8px}
  @media (max-width:640px){.input{grid-template-columns:1fr;}}
  .input input{padding:14px 16px;border:1px solid var(--bd);border-radius:12px;background:white;font-size:16px}
  [data-theme="dark"] .input input{background:#0d152b;color:var(--text)}
  .hint{color:var(--muted);font-size:13px}
  h2{margin:8px 0 6px 0}
  h3{margin:10px 0 8px 0}
  .grid2{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:840px){.grid2{grid-template-columns:1fr 1fr}}
  .list{display:grid;gap:8px}
  details{border:1px solid var(--bd);border-radius:12px;padding:8px 10px;background:color-mix(in oklab, var(--card) 94%, transparent)}
  summary{cursor:pointer;font-weight:700}
  .stat{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:640px){.stat{grid-template-columns:1fr}}
  .k{color:var(--muted);font-size:14px}
  .v{font-weight:900;font-size:20px}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
  .chip{border:1px solid var(--bd);background:transparent;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer}
  .chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .badgeb{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--bd);border-radius:999px;padding:6px 10px;font-size:12px}
  .footer-note{margin-top:12px;font-size:12px;color:var(--muted)}
  .chart{display:grid;gap:10px;margin-top:14px}
  .bar{position:relative;border-radius:12px;border:1px solid var(--bd);background:var(--barbg);height:44px;display:flex;align-items:center;overflow:hidden}
  .bar::before{content:"";position:absolute;inset:0;transform-origin:left center;transform:scaleX(var(--pct,0));}
  .bar.fal::before{background:linear-gradient(90deg, var(--bad), #ff9b9b)}
  .bar.tar::before{background:linear-gradient(90deg, var(--warn), #ffe08a)}
  .bar.ati::before{background:linear-gradient(90deg, var(--ok), #a7efd5)}
  .bar .lbl{position:relative;z-index:1;padding-left:12px;font-weight:800}
  .bar .val{position:absolute;right:10px;z-index:1;font-weight:900}
  .linkbtn{display:inline-block;margin-left:8px;border:1px solid var(--bd);padding:4px 8px;border-radius:999px;font-size:12px;text-decoration:none}
</style>
</head>
<body>
<header>
  <h1>ğŸ‘ª Aula Digital â€” Consulta para familias</h1>
  <div class="right">
    <button id="themeBtn" class="btn ghost small" title="Cambiar tema">ğŸŒ™ Oscuro</button>
  </div>
</header>

<main>
  <!-- Acceso -->
  <section class="card hero" id="search-card">
    <div>
      <h2>Encuentre el progreso de su hijo(a)</h2>
      <p class="hint">Escriba el <b>ID escolar</b> que le proporcionÃ³ la escuela para consultar tareas y asistencia.</p>
    </div>
    <div class="input">
      <input id="idInput" autocomplete="off" placeholder="Pegue aquÃ­ el ID entregado por la escuela" inputmode="latin-name">
      <button id="goBtn" class="btn primary">Buscar alumno</button>
      <button id="saveBtn" class="btn ghost">Recordar ID en este dispositivo</button>
    </div>
    <div class="hint">Este sitio <u>solo lee</u> los datos. No modifica nada en la libreta digital.</div>
  </section>

  <!-- Resultados -->
  <section id="student-view" style="display:none; margin-top:14px">
    <div class="card">
      <div class="topbar">
        <div>
          <h2 id="alumno-nombre">Alumno</h2>
          <div class="hint" id="alumno-id"></div>
          <div class="hint" id="grupo-label" style="margin-top:4px"></div>
          <div id="tri-subtitle" class="hint" style="margin-top:6px">Resumen de Todo</div>
        </div>
        <div>
          <button id="backBtn" class="btn ghost">Cambiar de alumno</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <div class="chips" id="tri-chips"></div>
        <div class="hint">Vea <b>Todo</b> o sÃ³lo un trimestre: <b>Trimestre 1</b> (M1), <b>Trimestre 2</b> (M2), <b>Trimestre 3</b> (M3).</div>
      </div>

      <div class="stat" style="margin-top:12px">
        <div><div class="k">Cumplimiento (trimestre elegido)</div><div class="v" id="stat-cump-tri">â€“</div></div>
        <div><div class="k">Totales â€” Trimestre</div><div class="v" id="stat-tot-tri">â€“</div></div>
        <div><div class="k">Asistencia â€” semana</div><div class="v" id="stat-aswk">â€“</div></div>
        <div><div class="k">Asistencia â€” 30 dÃ­as</div><div class="v" id="stat-as30">â€“</div></div>
        <div><div class="k">Asistencia total (histÃ³rica)</div><div class="v" id="stat-asHist">â€“</div></div>
        <div><div class="k">Faltas (histÃ³ricas)</div><div class="v" id="stat-faltHist">â€“</div></div>
        <!-- (Opcional) si quieres ver el relativo X (Y%):
        <div><div class="k">Asistencias â€” hoja (relativo)</div><div class="v" id="stat-asSheet">â€“</div></div>
        -->
      </div>

      <div class="chart" aria-label="Resumen visual del trimestre">
        <div class="bar fal" id="bar-fal"><span class="lbl">â³ Faltantes</span><span class="val" id="val-fal">0</span></div>
        <div class="bar tar" id="bar-tar"><span class="lbl">ğŸ•’ Tarde</span><span class="val" id="val-tar">0</span></div>
        <div class="bar ati" id="bar-ati"><span class="lbl">âœ… A tiempo</span><span class="val" id="val-ati">0</span></div>
      </div>

      <p class="footer-note" style="margin-top:10px">
        Importante: si alguna inasistencia fue <b>justificada</b>, no se preocupe; aunque aparezca aquÃ­ como falta, la escuela la revisa y no afecta indebidamente.
      </p>
    </div>

    <div class="grid2" style="margin-top:12px">
      <div class="card">
        <h3>â³ Trabajos faltantes</h3>
        <div id="faltantes" class="list"></div>
      </div>
      <div class="card">
        <h3>ğŸ•’ Entregados tarde</h3>
        <div id="tarde" class="list"></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>âœ… Entregados (a tiempo)</h3>
      <div id="atiempo" class="list"></div>
    </div>

    <p class="footer-note">Si detecta algÃºn dato que no coincide, contacte a la escuela para verificar la libreta digital.</p>
  </section>
</main>

<script>
/* ====== CONFIG ====== */
/* NUEVA HOJA + GIDs DE 5Â°B */
const SHEET_ID = '19godSKA4Yx9vNHrZpz6ReDeQFovMzlN7X0y6QX-BA6s';
const GIDS = {
  puntos: '0',
  asistencia: '1131375842',
  registro: '1025312588',
  presets: '495888198'
};
const GROUP_LABEL = '5to B maestro Emilio';

/* JSON de enlaces (opcional, puedes cambiar el nombre de archivo si quieres) */
const LINKS_JSON = 'data/links_5B.json';
let LINKMAP = {};

const $=s=>document.querySelector(s);
const strip=s=>String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
const norm=s=>strip(String(s||'').toLowerCase()).replace(/\s+/g,' ').trim();
const pad=n=>String(n).padStart(2,'0');
const ymd=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

/* === FECHAS ROBUSTAS === */
function normDate(s){
  const t=String(s||'').trim();
  if(!t) return '';
  // ISO y variantes: 2025-9-1 / 2025/09/01
  let m=t.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
  if(m){ const y=+m[1], mo=+m[2], d=+m[3]; return `${y}-${pad(mo)}-${pad(d)}`; }
  // DMY: 1/9/2025 o 01-09-2025
  m=t.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
  if(m){ const d=+m[1], mo=+m[2], y=+m[3]; return `${y}-${pad(mo)}-${pad(d)}`; }
  // GViz: Date(2025,8,30)
  m=t.match(/^Date\((\d{4})\s*,\s*(\d{1,2})\s*,\s*(\d{1,2})/i);
  if(m){ const y=+m[1], mo=+m[2], d=+m[3]; return ymd(new Date(y, mo, d)); }
  // Fallback
  const d=new Date(t); if(!isNaN(+d)) return ymd(d);
  return '';
}
function isPresent(v){
  const s=norm(v); if(!s) return false;
  if(!Number.isNaN(+s)) return (+s)>0; // '1' cuenta
  const s2=s.replace(/\s+/g,''); if(/^1\(100%?\)$/.test(s2)) return true;
  return ['x','âœ“','âœ”','p','presente','si','sÃ­','s','ok','true','asistio','asistiÃ³'].includes(s);
}
function getDateCols(cols){
  return cols.map((c,i)=>normDate(String(c).trim())?i:-1).filter(i=>i>=0);
}
/* NUEVO: columnas de fecha ACTIVAS (al menos alguien marcÃ³) */
function getActiveDateCols(cols, rows){
  const dcols=getDateCols(cols);
  return dcols.filter(i=>rows.some(r=>(r[i]!=='' && r[i]!=null)));
}

/* ====== LECTORES ====== */
let _cbSeq=0;
function fetchGViz(sheetId, sheetName){
  return new Promise((resolve,reject)=>{
    const cb=`__cb_${Date.now()}_${++_cbSeq}`;
    const url=`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?headers=1&tqx=out:json;responseHandler:${cb}&sheet=${encodeURIComponent(sheetName)}&ts=${Date.now()}`;
    const sc=document.createElement('script');
    const timeout=setTimeout(()=>{cleanup();reject(new Error('Timeout'))},12000);
    function cleanup(){clearTimeout(timeout); delete window[cb]; if(sc.parentNode) sc.parentNode.removeChild(sc); }
    window[cb]=(json)=>{cleanup(); try{
      let cols=(json.table?.cols||[]).map(c=>String(c.label||'').trim());
      let rows=(json.table?.rows||[]).map(r=>(r.c||[]).map(c=>c?.v ?? ''));
      const empty=cols.filter(c=>!c||/^[A-Z]$/.test(c)).length;
      if(empty>=Math.ceil(cols.length*0.5)&&rows.length){cols=rows[0].map(v=>String(v??'')); rows=rows.slice(1);}
      resolve({cols,rows});
    }catch(e){reject(e)} };
    sc.onerror=()=>{cleanup();reject(new Error('Error GViz'))};
    sc.src=url; document.head.appendChild(sc);
  });
}
async function fetchCSVByGid(sheetId,gid){
  const url=`https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}&ts=${Date.now()}`;
  const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error('CSV '+gid);
  const txt=await res.text(); const rows=parseCSV(txt); const cols=(rows.shift()||[]).map(v=>String(v??'')); return {cols,rows};
}
function parseCSV(t){
  const rows=[]; let row=[], cur='', q=false;
  for(let i=0;i<t.length;i++){
    const ch=t[i],nx=t[i+1];
    if(q){
      if(ch==='"'&&nx==='"'){cur+='"';i++;}
      else if(ch==='"'){q=false;}
      else cur+=ch;
    }else{
      if(ch==='"'){q=true;}
      else if(ch===','){row.push(cur);cur='';}
      else if(ch==='\n'||ch==='\r'){
        if(cur!==''||row.length){row.push(cur);rows.push(row);row=[];cur='';}
      }else cur+=ch;
    }
  }
  if(cur!==''||row.length){row.push(cur);rows.push(row);}
  return rows;
}

/* ====== PARSERS ====== */
function parseRegistro(cols,rows){
  const iUID=cols.findIndex(c=>/uid[_ ]?preset/i.test(c));
  const iF=cols.findIndex(c=>/^fecha$/i.test(c));
  const iFO=cols.findIndex(c=>/fecha.*objetivo/i.test(c));
  const iID=cols.findIndex(c=>/^(id|matric)/i.test(c));
  const iNom=cols.findIndex(c=>/^nombre/i.test(c));
  const iMat=cols.findIndex(c=>/^materia$/i.test(c));
  const iNum=cols.findIndex(c=>/n.?trabajo|n.? ?Â°/i.test(c));
  const iOri=cols.findIndex(c=>/^origen$/i.test(c));
  const iPag=cols.findIndex(c=>/^p[aÃ¡]gina/i.test(c));
  const iPts=cols.findIndex(c=>/^puntos$/i.test(c));
  const iAtr=cols.findIndex(c=>/atraso/i.test(c));
  const iMom=cols.findIndex(c=>/^momento$/i.test(c));
  const iNomT=cols.findIndex(c=>/nombre.*trabajo/i.test(c));
  return rows.map(r=>{
    const fecha=String(r[iF]??'').trim();
    const fo=String((iFO>=0?r[iFO]:'')??'').trim()||fecha;
    const atraso = (()=>{
      if(iAtr>=0 && r[iAtr]!=='' && r[iAtr]!=null) return +r[iAtr]||0;
      const d=new Date(fecha), o=new Date(fo); if(isNaN(+d)||isNaN(+o)) return 0;
      return Math.max(0, Math.round((d-o)/86400000));
    })();
    return {
      uidPreset:String((iUID>=0?r[iUID]:'')??'').trim(),
      fecha,
      fechaObjetivo:fo,
      id:String((iID>=0?r[iID]:'')??'').trim(),
      nombre:String((iNom>=0?r[iNom]:'')??'').trim(),
      materia:String((iMat>=0?r[iMat]:'')??'').trim(),
      numero:String((iNum>=0?r[iNum]:'')??'').trim(),
      origen:String((iOri>=0?r[iOri]:'')??'').trim(),
      pagina:String((iPag>=0?r[iPag]:'')??'').trim(),
      puntos:+((iPts>=0?r[iPts]:0)??0)||0,
      atrasoDias:atraso,
      momento:String((iMom>=0?r[iMom]:'')??'').trim(),
      nombreTrabajo:String((iNomT>=0?r[iNomT]:'')??'').trim()
    };
  });
}
function parsePresets(cols,rows){
  const iUID=cols.findIndex(c=>/uid[_ ]?preset/i.test(c));
  const iFO=cols.findIndex(c=>/fecha.*objetivo/i.test(c));
  const iMom=cols.findIndex(c=>/^momento$/i.test(c));
  const iMat=cols.findIndex(c=>/^materia$/i.test(c));
  const iNum=cols.findIndex(c=>/n.?trabajo|n.? ?Â°/i.test(c));
  const iOri=cols.findIndex(c=>/^origen$/i.test(c));
  const iPag=cols.findIndex(c=>/^p[aÃ¡]gina/i.test(c));
  const iNom=cols.findIndex(c=>/nombre.*trabajo/i.test(c));
  const iEUrl=cols.findIndex(c=>/url.*evidenc/i.test(c));
  const iESh =cols.findIndex(c=>/(hoja|sheet).*evidenc/i.test(c));
  return rows.map(r=>({
    uid:String((iUID>=0?r[iUID]:'')??'').trim(),
    fechaObjetivo:String((iFO>=0?r[iFO]:'')??'').trim(),
    momento:String((iMom>=0?r[iMom]:'')??'').trim(),
    materia:String((iMat>=0?r[iMat]:'')??'').trim(),
    numero:String((iNum>=0?r[iNum]:'')??'').trim(),
    origen:String((iOri>=0?r[iOri]:'')??'').trim(),
    pagina:String((iPag>=0?r[iPag]:'')??'').trim(),
    nombreTrabajo:String((iNom>=0?r[iNom]:'')??'').trim(),
    evidUrl:String((iEUrl>=0?r[iEUrl]:'')??'').trim(),
    evidSheet:String((iESh>=0?r[iESh]:'')??'').trim(),
  })).filter(p=>p.uid);
}

/* ====== ASISTENCIA (solo corregido) ====== */
function asistenciaAlumno(cols,rows,ref,start,end){
  const iId=cols.findIndex(c=>/^(id|matric)/i.test(c));
  const iNom=cols.findIndex(c=>/^nombre/i.test(c));
  let row=null;
  if(iId>=0 && ref.id) row=rows.find(r=>norm(r[iId])===norm(ref.id));
  if(!row && iNom>=0 && ref.nombre) row=rows.find(r=>norm(r[iNom])===norm(ref.nombre));
  if(!row) return {present:0,total:0,row:null};

  // Denominador: columnas de fecha ACTIVAS en el rango
  const activeCols=getActiveDateCols(cols, rows).filter(i=>{
    const d=normDate(cols[i]); return d && d>=start && d<=end;
  });

  const present=activeCols.reduce((acc,i)=>acc+(isPresent(row[i])?1:0),0);
  const total=activeCols.length;
  return {present,total,row};
}
function asistenciaHistorica(cols,rows,ref){
  const iId=cols.findIndex(c=>/^(id|matric)/i.test(c));
  const iNom=cols.findIndex(c=>/^nombre/i.test(c));
  let row=null;
  if(iId>=0 && ref.id) row=rows.find(r=>norm(r[iId])===norm(ref.id));
  if(!row && iNom>=0 && ref.nombre) row=rows.find(r=>norm(r[iNom])===norm(ref.nombre));
  if(!row) return {present:0,total:0};

  const activeCols=getActiveDateCols(cols, rows);
  const present=activeCols.reduce((acc,i)=>acc+(isPresent(row[i])?1:0),0);
  const total=activeCols.length;
  return {present,total};
}
/* Opcional: relativo X (Y%) como la columna â€œ10 (100%)â€ de la hoja */
function asistenciaRelativa(cols, rows, ref){
  const iId=cols.findIndex(c=>/^(id|matric)/i.test(c));
  const iNom=cols.findIndex(c=>/^nombre/i.test(c));
  let ri=-1;
  if(iId>=0 && ref.id) ri=rows.findIndex(r=>norm(r[iId])===norm(ref.id));
  if(ri<0 && iNom>=0 && ref.nombre) ri=rows.findIndex(r=>norm(r[iNom])===norm(ref.nombre));
  const dcols=getActiveDateCols(cols, rows);
  if(ri<0 || !dcols.length) return {present:0,max:0,text:'0 (0%)'};
  const count=r=>dcols.reduce((a,i)=>a+(isPresent(r[i])?1:0),0);
  const presentRow=count(rows[ri]);
  const maxDays=rows.reduce((m,r)=>Math.max(m,count(r)),0);
  if(maxDays<=0) return {present:0,max:0,text:'0 (0%)'};
  const pct=Math.min(100, Math.round(presentRow/maxDays*100));
  return {present:presentRow,max:maxDays,text:`${presentRow} (${pct}%)`};
}

function weekRange(d){
  const day=d.getDay();
  const diff=(day===0?-6:1-day);
  const mon=new Date(d); mon.setDate(d.getDate()+diff); mon.setHours(0,0,0,0);
  const fri=new Date(mon); fri.setDate(mon.getDate()+4);
  return [ymd(mon), ymd(fri)];
}

/* ====== CARGA Y RENDER ====== */
async function loadBlock(name){
  const names = {asistencia:'Asistencia', registro:'Registro de trabajos', presets:'Presets'};
  try{ return await fetchGViz(SHEET_ID, names[name]); }
  catch{ return await fetchCSVByGid(SHEET_ID, GIDS[name]); }
}
async function loadLinks(){
  try{
    const res=await fetch(LINKS_JSON,{cache:'no-store'});
    if(res.ok){
      const j=await res.json();
      if(j?.items) LINKMAP=j.items;
    }
  }catch{ /* opcional */ }
}

let ALL = {faltantes:[], tarde:[], atiempo:[], presets:[]};
let TRI='M2'; // Trimestre 2 por defecto

function setTriChips(){
  const host=$('#tri-chips');
  const opts=[['ALL','Todo'],['M1','Trimestre 1'],['M2','Trimestre 2'],['M3','Trimestre 3']];
  host.innerHTML=opts.map(([v,l])=>`<button class="chip ${TRI===v?'active':''}" data-v="${v}">${l}</button>`).join('');
  for(const b of host.querySelectorAll('.chip')){
    b.onclick=()=>{
      TRI=b.getAttribute('data-v');
      setTriChips();
      renderLists();
    };
  }
  $('#tri-subtitle').textContent='Resumen de '+({ALL:'Todo',M1:'Trimestre 1',M2:'Trimestre 2',M3:'Trimestre 3'}[TRI]);
}
function byTri(list){
  if(TRI==='ALL') return list;
  return list.filter(x=>String(x.momento||'').toUpperCase()===TRI);
}
function renderBarChart({faltantes,tarde,atiempo}){
  const max=Math.max(faltantes,tarde,atiempo,1);
  const set=(id,val)=>{
    const el=$(id);
    el.style.setProperty('--pct',(val/max).toFixed(3));
    el.querySelector('.val').textContent=val;
  };
  set('#bar-fal',faltantes);
  set('#bar-tar',tarde);
  set('#bar-ati',atiempo);
}
function linksFor(uid, preset){
  const urls = [];
  const rec = LINKMAP?.[uid];
  if (rec) {
    if (Array.isArray(rec.urls)) urls.push(...rec.urls);
    else if (rec.url) urls.push(rec.url);
  }
  if (preset?.evidUrl) urls.push(String(preset.evidUrl));
  const uniq = [...new Set(urls.map(u=>String(u||'').trim()).filter(Boolean))];
  if (!uniq.length) return '';
  return uniq.map((u,i)=>`<a class="linkbtn" href="${u}" target="_blank" rel="noopener">ğŸ“· Ver evidencia ${uniq.length>1?i+1:''}</a>`).join('');
}
function renderLists(){
  const falt=byTri(ALL.faltantes), tar=byTri(ALL.tarde), ati=byTri(ALL.atiempo);
  const totalTri = byTri(ALL.presets).length;
  const hechosTri = tar.length + ati.length;
  $('#stat-cump-tri').textContent = totalTri? `${Math.round(hechosTri/totalTri*100)}%` : 'â€“';
  $('#stat-tot-tri').textContent  = `Faltantes ${falt.length} Â· Tarde ${tar.length} Â· A tiempo ${ati.length} Â· Trabajos totales ${totalTri}`;
  renderBarChart({faltantes:falt.length, tarde:tar.length, atiempo:ati.length});
  const renderItem = (t) => {
    const mom = t.momento ? ` Â· ${t.momento}` : '';
    const fecha = t.fechaObjetivo ? ` Â· ${normDate(t.fechaObjetivo)}` : '';
    const nom = t.nombreTrabajo ? ` Â· <i>${t.nombreTrabajo}</i>` : '';
    const kLink = linksFor(t.uid, t);
    const kSheet = t.evidSheet ? ` <span class="badgeb">ğŸ“„ ${t.evidSheet}</span>` : '';
    return `<details>
      <summary><b>${t.materia||'â€“'}</b> â€” ${t.numero||'â€“'} (${t.origen||'â€“'}${t.pagina?' Â· p.'+t.pagina:''})${nom}${fecha}${mom}${kLink? ' ' + kLink : ''}${kSheet}</summary>
    </details>`;
  };
  $('#faltantes').innerHTML = falt.length ? falt.map(renderItem).join('') : '<div class="hint">No hay trabajos faltantes ğŸ’™</div>';
  $('#tarde').innerHTML     = tar.length   ? tar.map(renderItem).join('')   : '<div class="hint">No hay entregas tarde</div>';
  $('#atiempo').innerHTML   = ati.length   ? ati.map(renderItem).join('')   : '<div class="hint">AÃºn no hay entregas registradas</div>';
}

/* ====== CARGA (con asistencia corregida) ====== */
async function cargarAlumnoPorID(id){
  $('#student-view').style.display='none';
  $('#alumno-nombre').textContent='Cargandoâ€¦'; $('#alumno-id').textContent='';

  await loadLinks();

  const [asis, reg, pre] = await Promise.all([loadBlock('asistencia'), loadBlock('registro'), loadBlock('presets')]);

  const entregas = parseRegistro(reg.cols, reg.rows);
  const presets  = parsePresets(pre.cols, pre.rows);
  let entAlumno  = entregas.filter(t => norm(t.id) === norm(id));

  const nombreDeRegistro = entAlumno.find(e => e.nombre)?.nombre || '';

  const uids   = new Map(entAlumno.filter(t => t.uidPreset).map(t => [t.uidPreset, t]));
  const claves = new Map(entAlumno.filter(t => !t.uidPreset).map(t => [
    [norm(t.materia), norm(String(t.numero).replace(/^trabajo\s*/i,'')),
     norm(t.origen),  norm(t.pagina), normDate(t.fechaObjetivo)].join('|'), t
  ]));

  const faltantes=[], tarde=[], atiempo=[];
  for (const p of presets){
    let e = uids.get(p.uid);
    if (!e){
      const k = [norm(p.materia), norm(String(p.numero).replace(/^trabajo\s*/i,'')),
                 norm(p.origen),  norm(p.pagina), normDate(p.fechaObjetivo)].join('|');
      e = claves.get(k);
    }
    if (e) { (e.atrasoDias > 0 ? tarde : atiempo).push(p); } else { faltantes.push(p); }
  }
  ALL={faltantes,tarde,atiempo,presets};

  // Nombre visible + etiquetas
  const [w0,w1] = weekRange(new Date());
  const aw = asistenciaAlumno(asis.cols, asis.rows, {id, nombre:nombreDeRegistro}, w0, w1);
  const iNom = asis.cols.findIndex(c=>/^nombre/i.test(c));
  let nombre = nombreDeRegistro;
  if (aw.row && iNom>=0) nombre = String(aw.row[iNom]||'');
  if (!nombre){
    const iId=asis.cols.findIndex(c=>/^(id|matric)/i.test(c));
    if (iId>=0 && iNom>=0){
      const r=asis.rows.find(r=>norm(r[iId])===norm(id));
      if (r) nombre=String(r[iNom]||'');
    }
  }
  if (!nombre){
    alert('No encontramos ese ID. Verifique que estÃ© correcto (sin espacios) o contacte a la escuela.');
    return;
  }

  $('#alumno-nombre').textContent = nombre;
  $('#alumno-id').textContent     = 'ID: ' + id;
  $('#grupo-label').innerHTML     = `<span class="badgeb">ğŸ‘©â€ğŸ« Grupo: <b>${GROUP_LABEL}</b></span>`;

  // Asistencias (corregidas)
  const hoy=new Date();
  const a30 = asistenciaAlumno(asis.cols, asis.rows, {id, nombre:nombre}, ymd(new Date(hoy.getFullYear(),hoy.getMonth(),hoy.getDate()-30)), ymd(hoy));
  const ah  = asistenciaHistorica(asis.cols, asis.rows, {id, nombre:nombre});
  const rel = asistenciaRelativa(asis.cols, asis.rows, {id, nombre:nombre}); // opcional

  $('#stat-aswk').textContent     = aw.total  ? `${Math.round(aw.present/aw.total*100)}%  (${aw.present}/${aw.total})` : 'â€“';
  $('#stat-as30').textContent     = a30.total ? `${Math.round(a30.present/a30.total*100)}%  (${a30.present}/${a30.total})` : 'â€“';
  $('#stat-asHist').textContent   = ah.total  ? `${Math.round(ah.present/ah.total*100)}%  (${ah.present}/${ah.total})` : 'â€“';
  $('#stat-faltHist').textContent = ah.total ? `${ah.total - ah.present}` : 'â€“';
  const relEl=document.getElementById('stat-asSheet'); if(relEl) relEl.textContent = rel.text;

  // Pintar listas y grÃ¡fico de trabajos â€” ahora por defecto M2
  TRI='M2';
  setTriChips();
  renderLists();

  $('#student-view').style.display='block';
  window.scrollTo({top:document.body.offsetTop, behavior:'smooth'});
}

/* ====== UI ====== */
const themeBtn=$('#themeBtn');
function applyTheme(t){
  document.documentElement.setAttribute('data-theme', t);
  themeBtn.textContent=(t==='dark'?'â˜€ï¸ Claro':'ğŸŒ™ Oscuro');
  localStorage.setItem('familias_theme',t);
}
applyTheme(localStorage.getItem('familias_theme')||'light');
themeBtn.onclick=()=>applyTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');

$('#saveBtn').onclick=()=>{
  const v=$('#idInput').value.trim();
  if(!v){alert('Escriba el ID escolar.'); return;}
  localStorage.setItem('familias_id',v);
  alert('Listo. Guardado en este dispositivo.');
};
$('#goBtn').onclick=async()=>{
  const id=$('#idInput').value.trim().toUpperCase();
  if(!/^ID[A-Z0-9]{6,}$/.test(id)){
    alert('ID no vÃ¡lido. Revise que no tenga espacios ni letras minÃºsculas.');
    return;
  }
  try{
    await cargarAlumnoPorID(id);
  } catch(e){
    alert('No fue posible leer los datos: '+e.message);
  }
};
$('#idInput').addEventListener('keydown',e=>{ if(e.key==='Enter'){ $('#goBtn').click(); }});
const saved=localStorage.getItem('familias_id'); if(saved) $('#idInput').value=saved;
$('#backBtn')?.addEventListener('click',()=>{
  $('#student-view').style.display='none';
  window.scrollTo({top:0,behavior:'smooth'});
});
</script>
</body>
</html>
